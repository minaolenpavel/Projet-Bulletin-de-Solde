@page "/"
@using Bulletin_solde.Data
@using Bulletin_solde.Data.Models
@using Bulletin_solde.Data.Services
@using Bulletin_solde.Components
@using Microsoft.EntityFrameworkCore
@using System.IO
@using System.Text.Json.Nodes
@inject Data.ApplicationDbContext DbContext
@inject BulletinServices bServices
@inject IJSRuntime JS
@rendermode InteractiveServer

<h3>Liste des bulletins</h3>

<InputFile OnChange="HandleFileSelected" accept=".json" multiple/>

@code {
    private List<Bulletin> bulletins;
    protected async Task InitBulletinsList()
    {
        bulletins = await bServices.GetAllBulletins();
    }

    protected async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        if (e.FileCount == 1)
        {
            var file = e.File;

            using var stream = file.OpenReadStream();
            using var reader = new StreamReader(stream);
            string json = await reader.ReadToEndAsync();
            try
            {
                Bulletin? bulletin = bServices.ParseJson(json);
                if (bulletin != null)
                {
                    await DbContext.Bulletins.AddAsync(bulletin);
                    await DbContext.SaveChangesAsync();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine("Error parsing json" + e);
            }
        }
        else
        {
            var files = e.GetMultipleFiles();
            foreach(var file in files)
            {
                using var stream = file.OpenReadStream();
                using var reader = new StreamReader(stream);
                string json = await reader.ReadToEndAsync();
                Bulletin? bulletin = bServices.ParseJson(json);
                if (bulletin != null)
                {
                    await DbContext.Bulletins.AddAsync(bulletin);
                    await DbContext.SaveChangesAsync();
                }
            }
        }
    }


}
