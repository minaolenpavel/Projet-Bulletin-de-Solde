@using Bulletin_solde.Data.Models
@using Bulletin_solde.Data.Services
@inject Data.ApplicationDbContext DbContext
@inject BulletinServices bServices


<!-- <InputFile OnChange="HandleFileSelected" accept=".json" Multiple /> -->

<MudFileUpload T="IReadOnlyList<IBrowserFile>" FilesChanged="UploadFiles" MaximumFileCount="100">
    <ActivatorContent>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.CloudUpload">
            Importer .Json
        </MudButton>
    </ActivatorContent>
</MudFileUpload>


@code {
    [Parameter]
    public EventCallback OnFilesProcessed { get; set; }

    private List<Bulletin> bulletins;

    IList<IBrowserFile> files = new List<IBrowserFile>();
    private async void UploadFiles(IReadOnlyList<IBrowserFile> files)
    {
        foreach (var file in files)
        {
            this.files.Add(file);
        }
        await HandleFiles(files);

        await OnFilesProcessed.InvokeAsync();
    }

    protected async Task HandleFiles(IReadOnlyList<IBrowserFile> files)
    {
        //var files = e.GetMultipleFiles(maximumFileCount: 20); // Defines how many files allowed, no matter the size
        foreach (var file in files)
        {
            using var stream = file.OpenReadStream();
            using var reader = new StreamReader(stream);
            string json = await reader.ReadToEndAsync();
            Bulletin? bulletin = bServices.ParseJson(json);
            if (bulletin != null)
            {
                await DbContext.Bulletins.AddAsync(bulletin);
                await DbContext.SaveChangesAsync();
                StateHasChanged();
            }
        }
    }
}
